apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: external-dns-mikrotik
  namespace: core
  labels:
    app.kubernetes.io/name: external-dns-mikrotik
spec:
  interval: 1h
  chart:
    spec:
      chart: external-dns
      version: "8.0.*"
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 1h
  install:
    createNamespace: false
  values:
    # Use kubernetes-sigs image for better ARM64 support
    image:
      registry: registry.k8s.io
      repository: external-dns/external-dns
      tag: v0.20.0

    # Provider configuration - use webhook for MikroTik
    provider: webhook

    # ServiceAccount configuration
    serviceAccount:
      create: false
      name: external-dns-mikrotik

    # Init containers - wait for webhook to be ready
    initContainers:
      - name: wait-for-webhook
        image: busybox:1.36
        command:
          - sh
          - -c
          - |
            echo "Waiting for webhook to be ready..."
            until nc -z external-dns-mikrotik-webhook.core.svc.cluster.local 8888; do
              echo "Webhook not ready yet, waiting..."
              sleep 5
            done
            echo "Webhook is ready!"

    # Extra arguments for webhook provider
    extraArgs:
      webhook-provider-url: http://external-dns-mikrotik-webhook.core.svc.cluster.local:8888

    # Domain filter - configure for your local domain
    domainFilters:
      - local  # Replace with your actual local domain managed by MikroTik

    # Source configuration - watch both Ingress and Service resources
    sources:
      - ingress
      - service

    # Annotation filter - only manage resources with this annotation
    annotationFilter: "external-dns.alpha.kubernetes.io/target=mikrotik"

    # Policy configuration - sync creates, updates, and deletes DNS records
    policy: sync

    # Registry configuration - use TXT records to track ownership
    registry: txt
    txtOwnerId: firefly-mikrotik
    txtPrefix: externaldns-

    # Resource configuration
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

    # Node selector
    nodeSelector:
      type: pi

    # Log configuration
    logLevel: info
    logFormat: json
