apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
  labels:
    app.kubernetes.io/name: kube-prometheus-stack
spec:
  interval: 1h
  timeout: 15m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: "68.2.2"
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
      interval: 1h
  install:
    createNamespace: true
    crds: CreateReplace
    timeout: 15m
  upgrade:
    crds: CreateReplace
  values:
    # Global settings
    fullnameOverride: prometheus
    
    # Prometheus configuration
    prometheus:
      prometheusSpec:
        # Node selector to run on VM nodes only
        nodeSelector:
          node-role.kubernetes.io/mini: "true"
        
        # External labels for Thanos
        externalLabels:
          cluster: firefly
          replica: $(POD_NAME)
        
        # Retention settings (short-term, Thanos handles long-term)
        retention: 7d
        retentionSize: "45GB"
        
        # Storage
        storageSpec:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 50Gi
        
        # Resource requests/limits
        resources:
          requests:
            cpu: 500m
            memory: 4Gi
          limits:
            cpu: 2000m
            memory: 8Gi
        
        # Thanos sidecar configuration
        thanos:
          image: quay.io/thanos/thanos:v0.37.2
          version: v0.37.2
          objectStorageConfig:
            name: thanos-objstore-config
            key: objstore.yml
        
        # Service monitors
        serviceMonitorSelectorNilUsesHelmValues: false
        podMonitorSelectorNilUsesHelmValues: false
        ruleSelectorNilUsesHelmValues: false
        
      # Thanos service for sidecar
      thanosService:
        enabled: true
        type: ClusterIP
        port: 10901
      
      # Ingress for Prometheus (optional)
      ingress:
        enabled: false
    
    # Grafana configuration
    grafana:
      enabled: true
      adminPassword: admin-change-me
      
      # Node selector to run on VM nodes only
      nodeSelector:
        node-role.kubernetes.io/mini: "true"
      
      # Persistence
      persistence:
        enabled: true
        size: 10Gi
      
      # Resources
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 2Gi
      
      # Datasources
      additionalDataSources:
        - name: Thanos
          type: prometheus
          url: http://thanos-query:9090
          access: proxy
          isDefault: true
          jsonData:
            timeInterval: 30s
        - name: Loki
          type: loki
          url: http://loki-gateway
          access: proxy
          jsonData:
            maxLines: 1000
      
      # Dashboard providers
      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
            - name: 'default'
              orgId: 1
              folder: ''
              type: file
              disableDeletion: false
              editable: true
              options:
                path: /var/lib/grafana/dashboards/default
      
      # Ingress for Grafana
      ingress:
        enabled: false
      
      # Sidecar for loading dashboards
      sidecar:
        dashboards:
          enabled: true
          searchNamespace: ALL
        datasources:
          enabled: true
          searchNamespace: ALL
    
    # AlertManager configuration
    alertmanager:
      enabled: true
      alertmanagerSpec:
        # Node selector to run on VM nodes only
        nodeSelector:
          node-role.kubernetes.io/mini: "true"
        
        storage:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 5Gi
        
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
      
      ingress:
        enabled: false
    
    # Prometheus Operator
    prometheusOperator:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
    
    # Node Exporter
    nodeExporter:
      enabled: true
    
    # Kube State Metrics
    kubeStateMetrics:
      enabled: true
    
    # Default rules and alerts
    defaultRules:
      create: true
      rules:
        alertmanager: true
        etcd: true
        configReloaders: true
        general: true
        k8s: true
        kubeApiserver: true
        kubeApiserverAvailability: true
        kubeApiserverSlos: true
        kubelet: true
        kubeProxy: true
        kubePrometheusGeneral: true
        kubePrometheusNodeRecording: true
        kubernetesApps: true
        kubernetesResources: true
        kubernetesStorage: true
        kubernetesSystem: true
        kubeScheduler: true
        kubeStateMetrics: true
        network: true
        node: true
        nodeExporterAlerting: true
        nodeExporterRecording: true
        prometheus: true
        prometheusOperator: true
