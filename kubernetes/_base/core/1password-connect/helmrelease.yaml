apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: 1password-connect
  namespace: core
  labels:
    app.kubernetes.io/name: 1password-connect
spec:
  interval: 1h
  chart:
    spec:
      chart: connect
      version: "1.*"
      sourceRef:
        kind: HelmRepository
        name: 1password
        namespace: flux-system
      interval: 1h
  install:
    createNamespace: false
  values:
    # Connect server configuration
    connect:
      # Explicitly disable inline credentials
      credentials: ""
      credentials_base64: ""
      
      # Credentials from existing secret
      credentialsName: onepassword-credentials
      credentialsKey: 1password-credentials.json
      
      # API server configuration
      api:
        name: connect-api
        replicas: 1
        nodeSelector:
          type: pi
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        # HTTP port configuration
        httpPort: 8080
      
      # Sync server configuration
      sync:
        name: connect-sync
        replicas: 1
        nodeSelector:
          type: pi
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
        
        # HTTP port configuration
        httpPort: 8081
      
      # Service configuration
      service:
        type: ClusterIP
        port: 8080
    
    # Operator configuration
    operator:
      # Enable the operator
      create: true
      
      # Token configuration - using existing secret via custom environment variables
      # When token.value is not set, the operator will look for OP_CONNECT_TOKEN env var
      customEnvVars:
        - name: OP_CONNECT_TOKEN
          valueFrom:
            secretKeyRef:
              name: onepassword-token
              key: token
      
      # Node selector for operator
      nodeSelector:
        type: pi
      
      # Operator pod configuration
      replicas: 1
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi
      
      # Polling interval for checking 1Password items
      pollingInterval: 600
      
      # AutoRestart configuration
      autoRestart:
        enabled: true
