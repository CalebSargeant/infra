apiVersion: v1
kind: ConfigMap
metadata:
  name: atlantis-config
  namespace: automation
data:
  repos.json: |
    {
      "repos": [
        {
          "id": "github.com/CalebSargeant/infra",
          "workflow": "terragrunt",
          "apply_requirements": ["approved", "mergeable"],
          "allowed_overrides": ["workflow"],
          "allow_custom_workflows": true,
          "delete_source_branch_on_merge": false
        }
      ],
      "workflows": {
        "terragrunt": {
          "plan": {
            "steps": [
              "init",
              {
                "run": "terragrunt plan -input=false -out=$PLANFILE"
              }
            ]
          },
          "apply": {
            "steps": [
              {
                "run": "terragrunt apply -input=false $PLANFILE"
              }
            ]
          }
        }
      }
    }
  atlantis.yaml: |
    # Server-side configuration for Atlantis
    # This is mounted as a config file for the Atlantis server
    repos:
      - id: github.com/CalebSargeant/infra
        workflow: terragrunt
        apply_requirements: 
          - approved
          - mergeable
        allowed_overrides:
          - workflow
        allow_custom_workflows: true
        delete_source_branch_on_merge: false
    
    workflows:
      terragrunt:
        plan:
          steps:
            - init
            - run: terragrunt plan -input=false -out=$PLANFILE
        apply:
          steps:
            - run: terragrunt apply -input=false $PLANFILE
