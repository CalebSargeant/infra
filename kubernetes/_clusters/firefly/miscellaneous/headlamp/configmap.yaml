apiVersion: v1
kind: ConfigMap
metadata:
  name: headlamp-values
  namespace: misc
data:
  values.yaml: |
    config:
      baseURL: ""
      inCluster: true
      enableDynamicClusters: false
      pluginsDir: /build/plugins

    serviceAccount:
      create: false
      name: headlamp-admin

    initContainers:
      - command:
          - /bin/sh
          - -c
          - mkdir -p /build/plugins && cp -r /plugins/* /build/plugins/ && chown -R 100:101 /build
        image: ghcr.io/headlamp-k8s/headlamp-plugin-flux:latest
        imagePullPolicy: Always
        name: headlamp-plugin-flux
        securityContext:
          runAsNonRoot: false
          privileged: false
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
          - mountPath: /build/plugins
            name: headlamp-plugins
      - command:
          - /bin/sh
          - -c
          - mkdir -p /build/plugins && cp -r /plugins/* /build/plugins/ && chown -R 100:101 /build
        image: quay.io/kubescape/headlamp-plugin:latest
        imagePullPolicy: Always
        name: headlamp-plugin-kubescape
        securityContext:
          runAsNonRoot: false
          privileged: false
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
          - mountPath: /build/plugins
            name: headlamp-plugins
      - command:
          - /bin/sh
          - -c
          - mkdir -p /build/plugins && cp -r /plugins/* /build/plugins/ && chown -R 100:101 /build
        image: ghcr.io/headlamp-k8s/headlamp-plugin-ai-assistant:latest
        imagePullPolicy: Always
        name: headlamp-plugin-ai-assistant
        securityContext:
          runAsNonRoot: false
          privileged: false
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
          - mountPath: /build/plugins
            name: headlamp-plugins

      - command:
          - /bin/sh
          - -c
          - |
            set -e
            echo "Building OpenCost plugin from source..."
            cd /tmp
            apk add --no-cache git npm
            git clone --depth 1 https://github.com/filipevrevez/headlamp-plugins.git
            cd headlamp-plugins/opencost
            npm install
            npm run build
            npx headlamp-plugin extract . /build/plugins/opencost
            chown -R 100:101 /build
            echo "OpenCost plugin built successfully"
        image: node:20-alpine
        imagePullPolicy: IfNotPresent
        name: headlamp-plugin-opencost
        securityContext:
          runAsNonRoot: false
          privileged: false
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
          - mountPath: /build/plugins
            name: headlamp-plugins
      - command:
          - /bin/sh
          - -c
          - |
            set -e
            echo "Building cert-manager plugin from source..."
            cd /tmp
            apk add --no-cache git npm
            git clone --depth 1 https://github.com/headlamp-k8s/plugins.git headlamp-official-plugins
            cd headlamp-official-plugins/cert-manager
            npm install
            npm run build
            npx headlamp-plugin extract . /build/plugins/cert-manager
            chown -R 100:101 /build
            echo "cert-manager plugin built successfully"
        image: node:20-alpine
        imagePullPolicy: IfNotPresent
        name: headlamp-plugin-cert-manager
        securityContext:
          runAsNonRoot: false
          privileged: false
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
          - mountPath: /build/plugins
            name: headlamp-plugins
      - command:
          - /bin/sh
          - -c
          - |
            set -e
            echo "Building gatekeeper plugin from source..."
            cd /tmp
            apk add --no-cache git npm
            git clone --depth 1 https://github.com/sozercan/gatekeeper-headlamp-plugin.git
            cd gatekeeper-headlamp-plugin
            npm install
            npm run build
            npx headlamp-plugin extract . /build/plugins/gatekeeper
            chown -R 100:101 /build
            echo "gatekeeper plugin built successfully"
        image: node:20-alpine
        imagePullPolicy: IfNotPresent
        name: headlamp-plugin-gatekeeper
        securityContext:
          runAsNonRoot: false
          privileged: false
          runAsUser: 0
          runAsGroup: 0
        volumeMounts:
          - mountPath: /build/plugins
            name: headlamp-plugins

    ingress:
      enabled: false

    nodeSelector:
      type: pi

    resources:
      requests:
        cpu: 10m
        memory: 100Mi
      limits:
        memory: 100Mi

    volumeMounts:
      - name: kubeconfigs
        mountPath: /home/headlamp/.config/Headlamp/kubeconfigs
        readOnly: true
      - mountPath: /build/plugins
        name: headlamp-plugins

    volumes:
      - name: kubeconfigs
        secret:
          secretName: headlamp-kubeconfigs
      - name: headlamp-plugins
        emptyDir: {}
