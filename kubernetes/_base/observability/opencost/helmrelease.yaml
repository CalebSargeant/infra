apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: opencost
  namespace: observability
  labels:
    app.kubernetes.io/name: opencost
spec:
  interval: 1h
  chart:
    spec:
      chart: opencost
      version: "1.43.2"
      sourceRef:
        kind: HelmRepository
        name: opencost
        namespace: flux-system
      interval: 1h
  install:
    createNamespace: true
  values:
    # OpenCost configuration
    opencost:
      # Prometheus integration
      prometheus:
        internal:
          enabled: true
          serviceName: prometheus-operated
          namespaceName: observability
          port: 9090
      
      # UI configuration
      ui:
        enabled: true
        ingress:
          enabled: false
      
      # Resources
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          memory: 512Mi

      # Metrics exporter
      exporter:
        enabled: true
        resources:
          requests:
            cpu: 10m
            memory: 100Mi
          limits:
            memory: 100Mi

      # Cloud cost configuration
      # Note: Cloud credentials should be provided via secrets
      cloudCost:
        enabled: true
        # AWS configuration - requires aws-credentials secret
        aws:
          enabled: false
          # Secret ref will be: opencost-aws-credentials
        # GCP configuration - requires gcp-credentials secret
        gcp:
          enabled: false
          # Secret ref will be: opencost-gcp-credentials
        # Azure configuration - requires azure-credentials secret
        azure:
          enabled: false
          # Secret ref will be: opencost-azure-credentials
        # OCI configuration - requires oci-credentials secret
        oci:
          enabled: false
          # Secret ref will be: opencost-oci-credentials
      
      # Cloud integration secret for storage-based configurations
      # This secret contains cloud-integration.json for Azure Storage cost exports
      cloudIntegrationSecret: opencost-cloud-integration
      
      # Environment variables
      exporter:
        extraEnv:
          CLOUD_COST_CONFIG_PATH:
            value: "/var/configs/cloud-integration/cloud-integration.json"
      
      # Custom pricing
      customPricing:
        enabled: false
        # Can be configured later for custom node pricing
      
    # ServiceMonitor for Prometheus Operator
    serviceMonitor:
      enabled: true
      namespace: observability
      labels:
        prometheus: kube-prometheus-stack
