apiVersion: batch/v1
kind: Job
metadata:
  name: minio-setup
  namespace: core
  labels:
    app.kubernetes.io/name: minio-setup
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: mc
          image: quay.io/minio/mc:RELEASE.2024-12-11T17-49-26Z
          command:
            - /bin/sh
            - -c
            - |
              #!/bin/sh
              set -e
              echo "Waiting for MinIO to be ready..."
              until mc alias set myminio http://minio:9000 admin $MINIO_ROOT_PASSWORD; do
                echo "Waiting for MinIO..."
                sleep 5
              done
              
              echo "Creating buckets..."
              mc mb --ignore-existing myminio/thanos-metrics
              mc mb --ignore-existing myminio/loki-chunks
              mc mb --ignore-existing myminio/loki-ruler
              
              echo "Setting bucket policies to private..."
              mc anonymous set none myminio/thanos-metrics
              mc anonymous set none myminio/loki-chunks
              mc anonymous set none myminio/loki-ruler
              
              echo "Creating service accounts..."
              mc admin user add myminio thanos $THANOS_PASSWORD || echo "User thanos may already exist"
              mc admin user add myminio loki $LOKI_PASSWORD || echo "User loki may already exist"
              
              echo "Creating policies..."
              cat > /tmp/thanos-policy.json <<EOF
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": ["s3:*"],
                    "Resource": ["arn:aws:s3:::thanos-metrics", "arn:aws:s3:::thanos-metrics/*"]
                  }
                ]
              }
              EOF
              
              cat > /tmp/loki-policy.json <<EOF
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": ["s3:*"],
                    "Resource": [
                      "arn:aws:s3:::loki-chunks", 
                      "arn:aws:s3:::loki-chunks/*",
                      "arn:aws:s3:::loki-ruler",
                      "arn:aws:s3:::loki-ruler/*"
                    ]
                  }
                ]
              }
              EOF
              
              mc admin policy create myminio thanos-policy /tmp/thanos-policy.json || echo "Policy may already exist"
              mc admin policy create myminio loki-policy /tmp/loki-policy.json || echo "Policy may already exist"
              
              mc admin policy attach myminio thanos-policy --user thanos
              mc admin policy attach myminio loki-policy --user loki
              
              echo "MinIO setup complete!"
          env:
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: root-password
            - name: THANOS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: thanos-password
            - name: LOKI_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: loki-password
