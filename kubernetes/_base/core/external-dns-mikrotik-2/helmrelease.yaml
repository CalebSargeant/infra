apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: external-dns-mikrotik-2
  namespace: core
  labels:
    app.kubernetes.io/name: external-dns-mikrotik-2
spec:
  interval: 1h
  chart:
    spec:
      chart: external-dns
      version: "8.0.*"
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
      interval: 1h
  install:
    createNamespace: false
  values:
    # Provider configuration - use webhook for MikroTik
    provider: webhook

    # Extra arguments for webhook provider
    extraArgs:
      - --webhook-provider-url=http://external-dns-mikrotik-2-webhook.core.svc.cluster.local:8888

    # Domain filter - configure for your local domain
    domainFilters:
      - local  # Replace with your actual local domain managed by MikroTik

    # Source configuration - watch both Ingress and Service resources
    sources:
      - ingress
      - service

    # Policy configuration - sync creates, updates, and deletes DNS records
    policy: sync

    # Registry configuration - use TXT records to track ownership
    registry: txt
    txtOwnerId: firefly-mikrotik-2
    txtPrefix: externaldns-

    # Resource configuration
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

    # Node selector
    nodeSelector:
      type: pi

    # Log configuration
    logLevel: info
    logFormat: json
